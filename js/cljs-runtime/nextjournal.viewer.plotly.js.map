{"version":3,"sources":["nextjournal/viewer/plotly.cljs"],"mappings":"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","names":["nextjournal.viewer.plotly/default-layout","G__61786","and__4221__auto__","js/window","cljs.core.assoc","nextjournal.viewer.plotly/default-graph-options","nextjournal.viewer.plotly/default-min-margin","nextjournal.viewer.plotly/adjust-layout-margins","layout","cljs.core.update","margin","cljs.core.merge_with","cljs.core/max","cljs.core.get","nextjournal.viewer.plotly/deep-merge-maps","m1","m2","cljs.core/map?","nextjournal.viewer.plotly/graph-layout-with-defaults","cljs.core.js__GT_clj","cljs.core/empty?","cljs.core/clj->js","nextjournal.viewer.plotly/coerce-val","value","js/JSON","nextjournal.viewer.plotly/viewer*","this","reagent.core/current-component","nextjournal.ui.components.d3-require/with","p__61816","map__61817","cljs.core/PROTOCOL_SENTINEL","cljs.core.apply","cljs.core/hash-map","obj61819","js/undefined","obj61820","Plotly","relayout","Plots","plotly-el","map__61821","obj61823","coerced","value-object","obj61825","out61826","k__55788__auto__","applied-science.js-interop.impl/in?*","obj61829","obj61830","obj61824","obj61833","obj61834","obj61837","obj61838","goog.functions/debounce","G__61841","G__61842","obj__55881__auto__","f__55882__auto__","reason","lambdaisland.glogi.log","cljs.core/identity","obj61843","obj61844","nextjournal.viewer.plotly/viewer"],"sourcesContent":["(ns nextjournal.viewer.plotly\r\n  (:require [applied-science.js-interop :as j]\r\n            [goog.functions :as gf]\r\n            [nextjournal.log :as log]\r\n            [nextjournal.ui.components.d3-require :as d3-require]\r\n            [nextjournal.util.cljs-extensions]\r\n            [reagent.core :as r]))\r\n\r\n(def default-layout\r\n  (cond-> {\"font\" {\"family\" \"'Verlag A', 'Verlag B', -apple-system, '.SFNSText-Regular', 'San Francisco', 'Roboto', 'Segoe UI', 'Helvetica Neue', 'Arial', sans-serif\"\r\n                   \"size\" 14\r\n                   \"color\" \"#343434\"}\r\n           \"height\" 450\r\n           \"autosize\" false}\r\n    (and (exists? js/window) (.hasOwnProperty js/window \"ontouchstart\"))\r\n    (assoc \"dragmode\" false)))\r\n\r\n(def default-graph-options #js {:displayModeBar false\r\n                                :displayLogo false})\r\n\r\n(def default-min-margin {\"r\" 0 \"l\" 30 \"b\" 0 \"t\" 20})\r\n\r\n(defn adjust-layout-margins [layout]\r\n  (update layout \"margin\"\r\n          (fn [margin]\r\n            (merge-with max\r\n                        default-min-margin\r\n                        margin\r\n                        (when (get layout \"title\")\r\n                          {\"t\" 60})))))\r\n\r\n(defn deep-merge-maps\r\n  \"Like merge, but merges maps recursively.\"\r\n  [m1 m2]\r\n  (if (and (map? m1) (map? m2))\r\n    (merge-with deep-merge-maps m1 m2)\r\n    m2))\r\n\r\n(defn graph-layout-with-defaults [layout]\r\n  (let [layout (js->clj layout)\r\n        layout (if (empty? layout) {} layout)]\r\n    (-> (deep-merge-maps default-layout layout)\r\n        adjust-layout-margins\r\n        clj->js)))\r\n\r\n(defn coerce-val [value]\r\n  (cond\r\n    (string? value)\r\n    (.parse js/JSON value)\r\n    (map? value)\r\n    (clj->js value)\r\n    :else\r\n    value))\r\n\r\n(defn viewer* [value]\r\n  (let [this (r/current-component)]\r\n    [d3-require/with {:package \"plotly.js-dist@1.51.1\"}\r\n     (j/fn [^:js {:as Plotly :keys [relayout Plots]}]\r\n       [:div.code-plotly-result\r\n        {:class \"flex justify-center items-center\"\r\n         :ref (fn [^js plotly-el]\r\n                (if plotly-el\r\n                  (j/let [^:js {:keys [layout] :as coerced} (coerce-val value)\r\n                          value-object (-> coerced\r\n                                           (j/select-keys [:data :frames])\r\n                                           (j/assoc! :layout (graph-layout-with-defaults layout)\r\n                                                     :config default-graph-options))]\r\n                    (j/assoc! this :resize-listener\r\n                              (gf/debounce\r\n                               (fn []\r\n                                 (relayout plotly-el (clj->js (graph-layout-with-defaults layout)))\r\n                                 (-> Plots (.resize plotly-el)))\r\n                               100))\r\n                    (-> Plotly\r\n                        (j/call :newPlot\r\n                                plotly-el\r\n                                value-object)\r\n                        (j/call :catch\r\n                                (fn new-plot-error [reason]\r\n                                  (log/error ::insert-plot \"Plotly Error\" :el plotly-el :reason reason))))\r\n                    (.addEventListener js/window \"resize\" (j/get this :resize-listener)))\r\n                  (.removeEventListener js/window \"resize\" (j/get this :resize-listener))))}])]))\r\n\r\n;; wrapper is used so that `viewer*` is not called as a function - it needs its own reagent component\r\n(defn viewer [value]\r\n  ^{:nextjournal/viewer :reagent} [viewer* value])\r\n"]}
{"version":3,"sources":["nextjournal/clojure_mode/test_utils.cljs"],"mappings":"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","names":["nextjournal.clojure-mode.test-utils/make-state","extensions","doc","vec__60579","cljs.core.nth","ranges","cljs.core/re-seq","cljs.core.reduce","p__60582","vec__60583","match","cljs.core._EQ_","cljs.core.conj","js/module$node_modules$$codemirror$state$dist$index_cjs.EditorSelection","clojure.string/starts-with?","cljs.core.subs","cljs.core/count","js/module$node_modules$$codemirror$state$dist$index_cjs.EditorState","cljs.core/seq","cljs.core/to-array","js/undefined","G__60587","Array60588","nextjournal.clojure-mode.test-utils/state-str","state","cljs.core/reverse","p__60592","map__60593","cljs.core/PROTOCOL_SENTINEL","cljs.core.apply","cljs.core/hash-map","obj60597","obj60599","obj60601","empty","from","to","nextjournal.clojure-mode.test-utils/apply-cmd","cmd","cljs.core/deref","!tr","cljs.core.atom","_","G__60605","p1__60604#","cljs.core/reset!","tr","obj60606","js/Error","nextjournal.clojure-mode.test-utils/apply-f","cljs.core/array?","cljs.core/fn?"],"sourcesContent":["(ns nextjournal.clojure-mode.test-utils\r\n  (:require [\"@codemirror/state\" :as cm-state\r\n             :refer [EditorState EditorSelection Extension StateCommand\r\n                     ChangeSet ChangeDesc TransactionSpec StrictTransactionSpec]]\r\n            [applied-science.js-interop :as j]\r\n            [clojure.string :as str]\r\n            [nextjournal.clojure-mode.extensions.formatting :as format]))\r\n\r\n;; (de)serialize cursors| and <selections> for testing\r\n\r\n(defn make-state [extensions doc]\r\n  (let [[doc ranges] (->> (re-seq #\"\\||<[^>]*?>|[^<>|]+\" doc)\r\n                          (reduce (fn [[^string doc ranges] match]\r\n                                    (cond (= match \"|\")\r\n                                          [doc (conj ranges (.cursor EditorSelection (count doc)))]\r\n\r\n                                          (str/starts-with? match \"<\")\r\n                                          [(str doc (subs match 1 (dec (count match))))\r\n                                           (conj ranges (.range EditorSelection\r\n                                                                (count doc)\r\n                                                                (+ (count doc) (- (count match) 2))))]\r\n                                          :else\r\n                                          [(str doc match) ranges])) [\"\" []]))]\r\n    (.create EditorState\r\n             #js{:doc doc\r\n                 :selection (if (seq ranges)\r\n                              (.create EditorSelection (to-array ranges))\r\n                              js/undefined)\r\n                 :extensions (cond-> #js[(.. EditorState -allowMultipleSelections (of true))]\r\n                               extensions\r\n                               (j/push! extensions))})))\r\n\r\n(defn state-str [^js state]\r\n  (let [doc (str (.-doc state))]\r\n    (->> (.. state -selection -ranges)\r\n         reverse\r\n         (reduce (j/fn [doc ^:js {:keys [empty from to]}]\r\n                   (if empty\r\n                     (str (subs doc 0 from) \"|\" (subs doc from))\r\n                     (str (subs doc 0 from) \"<\" (subs doc from to) \">\" (subs doc to)))) doc))))\r\n\r\n(comment\r\n (-> (make-state #js[] \"<a>b|c<d\\n>a<b>c|\")\r\n     (state-str)\r\n     (= \"<a>b|c<d\\n>a<b>c|\"))\r\n\r\n )\r\n\r\n(defn apply-cmd [extensions cmd doc]\r\n  (let [state (make-state extensions doc)\r\n        !tr (atom nil)\r\n        _ (cmd #js{:state state\r\n                   :dispatch #(reset! !tr %)})\r\n        tr @!tr]\r\n    (state-str (j/get tr :state))))\r\n\r\n(defn apply-f [extensions cmd doc]\r\n  {:pre [(array? extensions)\r\n         (fn? cmd)\r\n         (string? doc)]}\r\n  (let [state (make-state extensions doc)\r\n        tr (cmd state)]\r\n    (state-str (if tr (.-state tr) state))))\r\n"]}